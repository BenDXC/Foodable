name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
      version:
        description: 'Version to deploy'
        required: false
        type: string

concurrency:
  group: deploy-${{ inputs.environment || github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      version: ${{ steps.set-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: set-env
        run: |
          ENV="${{ inputs.environment || github.event.inputs.environment || 'staging' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Set version
        id: set-version
        run: |
          if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    name: Build & Deploy to ${{ needs.prepare.outputs.environment }}
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ needs.prepare.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.API_URL }}

      - name: Build backend
        working-directory: backend
        run: npm run build

      # --- Frontend Deployment ---

      - name: Deploy frontend to Vercel
        if: env.VERCEL_TOKEN != ''
        run: echo "Deploying frontend to Vercel..."
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        continue-on-error: true

      - name: Deploy frontend to Netlify
        if: env.NETLIFY_AUTH_TOKEN != ''
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=frontend/dist --prod=${{ needs.prepare.outputs.environment == 'production' }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        continue-on-error: true

      - name: Deploy frontend to GitHub Pages
        if: github.ref == 'refs/heads/main' && needs.prepare.outputs.environment == 'production'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/dist
          cname: foodable.example.com
        continue-on-error: true

      # --- Backend Deployment ---

      - name: Prepare backend production deps
        working-directory: backend
        run: |
          rm -rf node_modules
          npm install --omit=dev

      - name: Deploy backend to Heroku
        if: env.HEROKU_API_KEY != ''
        uses: akhileshns/heroku-deploy@v3.14.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: backend
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HD_NODE_ENV: production
          HD_JWT_SECRET: ${{ secrets.JWT_SECRET }}
          HD_DB_HOST: ${{ secrets.DB_HOST }}
          HD_DB_USER: ${{ secrets.DB_USER }}
          HD_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          HD_DB_NAME: ${{ secrets.DB_NAME }}
        continue-on-error: true

      - name: Deploy backend via SSH
        if: env.SSH_PRIVATE_KEY != ''
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /var/www/foodable-backend
            git pull origin main
            npm install --production
            npm run build
            pm2 restart foodable-api
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "Deployed to: ${{ needs.prepare.outputs.environment }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"

  post-deploy:
    name: Post-Deployment Checks
    needs: [prepare, build-and-deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      - name: Health checks
        run: |
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            curl -sf "${{ secrets.BACKEND_URL }}/api/v1/health" && echo "Backend OK" || echo "Backend check failed"
          fi
          if [ -n "${{ secrets.FRONTEND_URL }}" ]; then
            curl -sf "${{ secrets.FRONTEND_URL }}" && echo "Frontend OK" || echo "Frontend check failed"
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed - ${{ needs.prepare.outputs.environment }}`,
              body: `Deployment to **${{ needs.prepare.outputs.environment }}** failed.\n\n` +
                    `- Version: ${{ needs.prepare.outputs.version }}\n` +
                    `- Run: ${context.runNumber}\n\n` +
                    `Please investigate and rollback if necessary.`,
              labels: ['deployment', 'incident']
            });
        continue-on-error: true

      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Deploy to ${{ needs.prepare.outputs.environment }}: ${{ needs.build-and-deploy.result }} (v${{ needs.prepare.outputs.version }})"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
