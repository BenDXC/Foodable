name: Check for Duplicates

on:
  workflow_dispatch:

jobs:
  check-tags:
    name: Check for Duplicate Tags
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for duplicate tags
        run: |
          echo "Checking for duplicate tags..."
          
          # Get all tags
          TAGS=$(git tag -l)
          
          if [ -z "$TAGS" ]; then
            echo "No tags found"
            exit 0
          fi
          
          # Check for duplicates
          DUPLICATES=$(echo "$TAGS" | sort | uniq -d)
          
          if [ -n "$DUPLICATES" ]; then
            echo "Duplicate tags found:"
            echo "$DUPLICATES"
            exit 1
          else
            echo "No duplicate tags found"
            echo "Total tags: $(echo "$TAGS" | wc -l)"
            echo ""
            echo "Existing tags:"
            echo "$TAGS"
          fi

      - name: Check tag format
        run: |
          echo "Checking tag format (should be v*.*.*)..."
          
          INVALID_TAGS=$(git tag -l | grep -v '^v[0-9]\+\.[0-9]\+\.[0-9]\+' || true)
          
          if [ -n "$INVALID_TAGS" ]; then
            echo "Warning: Tags not following semver format:"
            echo "$INVALID_TAGS"
          else
            echo "All tags follow semantic versioning format"
          fi

  check-releases:
    name: Check for Duplicate Releases
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check GitHub releases
        uses: actions/github-script@v8
        with:
          script: |
            console.log('Checking for duplicate releases...');
            
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              console.log(`Total releases: ${releases.length}`);
              
              // Check for duplicate tags
              const tags = releases.map(r => r.tag_name);
              const uniqueTags = [...new Set(tags)];
              
              if (tags.length !== uniqueTags.length) {
                console.log('Duplicate releases found!');
                const duplicates = tags.filter((tag, index) => tags.indexOf(tag) !== index);
                console.log('Duplicates:', duplicates);
                core.setFailed('Duplicate releases detected');
              } else {
                console.log('No duplicate releases');
              }
              
              // List all releases
              console.log('\nExisting releases:');
              releases.forEach(release => {
                console.log(`- ${release.tag_name}: ${release.name}`);
              });
              
              // Check for releases without tags
              const releasesWithoutTags = releases.filter(r => !r.tag_name);
              if (releasesWithoutTags.length > 0) {
                console.log('Warning: Releases without tags:', releasesWithoutTags.length);
              }
              
            } catch (error) {
              console.log('No releases found or error:', error.message);
            }

  check-workflow-conflicts:
    name: Check Workflow Conflicts
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for release creation conflicts
        run: |
          echo "Checking workflows for potential duplicate release creation..."
          
          # Search for release creation patterns
          echo ""
          echo "=== Workflows that might create releases ==="
          grep -r "createRelease\|semantic-release\|action-gh-release" .github/workflows/ || echo "No matches found"
          
          echo ""
          echo "=== Analysis ==="
          echo "release.yml - Uses semantic-release (primary release creator)"
          echo "deploy.yml - Only updates existing releases (no creation)"
          echo ""
          echo "=== Triggers ==="
          echo "release.yml triggers on:"
          grep -A 5 "^on:" .github/workflows/release.yml | head -10
          echo ""
          echo "deploy.yml triggers on:"
          grep -A 10 "^on:" .github/workflows/deploy.yml | head -15
          
          echo ""
          echo "No workflow conflicts detected"

  summary:
    name: Duplicate Check Summary
    needs: [check-tags, check-releases, check-workflow-conflicts]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Summary
        run: |
          echo "=== Duplicate Check Results ==="
          echo "Tags Check: ${{ needs.check-tags.result }}"
          echo "Releases Check: ${{ needs.check-releases.result }}"
          echo "Workflow Conflicts: ${{ needs.check-workflow-conflicts.result }}"
          
          if [ "${{ needs.check-tags.result }}" != "success" ] || \
             [ "${{ needs.check-releases.result }}" != "success" ] || \
             [ "${{ needs.check-workflow-conflicts.result }}" != "success" ]; then
            echo "Some checks failed"
            exit 1
          else
            echo "All duplicate checks passed"
          fi
