name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Run all quality checks in parallel
  lint:
    name: Code Quality & Linting
    uses: ./.github/workflows/linting.yml

  frontend-tests:
    name: Frontend Tests
    uses: ./.github/workflows/frontend-tests.yml

  backend-tests:
    name: Backend Tests
    uses: ./.github/workflows/backend-tests.yml

  build:
    name: Build Check
    uses: ./.github/workflows/build.yml

  security:
    name: Security Scanning
    uses: ./.github/workflows/security.yml
    secrets: inherit

  # Summary job that waits for all checks
  ci-summary:
    name: CI Pipeline Summary
    needs: [lint, frontend-tests, backend-tests, build, security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all CI jobs
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Linting: ${{ needs.lint.result }}"
          echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
          echo "Backend Tests: ${{ needs.backend-tests.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "=========================="
          
          # Fail if any critical job failed
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.frontend-tests.result }}" == "failure" ] || \
             [ "${{ needs.backend-tests.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ]; then
            echo "CI Pipeline Failed"
            exit 1
          fi
          
          # Warn if security failed but don't block
          if [ "${{ needs.security.result }}" == "failure" ]; then
            echo "Warning: Security checks failed (non-blocking)"
          fi
          
          echo "CI Pipeline Passed"

      - name: Create status comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const results = {
              lint: '${{ needs.lint.result }}',
              frontend: '${{ needs.frontend-tests.result }}',
              backend: '${{ needs.backend-tests.result }}',
              build: '${{ needs.build.result }}',
              security: '${{ needs.security.result }}'
            };
            
            const emoji = (result) => result === 'success' ? 'pass' : result === 'failure' ? 'FAIL' : 'warn';
            
            const comment = `## CI Pipeline Results
            
            | Check | Status |
            |-------|--------|
            | Code Quality & Linting | ${emoji(results.lint)} ${results.lint} |
            | Frontend Tests | ${emoji(results.frontend)} ${results.frontend} |
            | Backend Tests | ${emoji(results.backend)} ${results.backend} |
            | Build | ${emoji(results.build)} ${results.build} |
            | Security Scanning | ${emoji(results.security)} ${results.security} |
            
            ${results.lint === 'success' && results.frontend === 'success' && results.backend === 'success' && results.build === 'success' ? '**All checks passed!**' : '**Some checks failed - please review**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
