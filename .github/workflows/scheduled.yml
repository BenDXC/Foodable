name: Scheduled Checks

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

concurrency:
  group: scheduled
  cancel-in-progress: true

jobs:
  # ── Full Security Scan ──────────────────────────────────────────────
  security-deep:
    name: Deep Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: npm audit
        run: |
          echo "=== Frontend ==="
          cd frontend && npm audit --json > ../frontend-audit.json || true && cd ..
          echo "=== Backend ==="
          cd backend && npm audit --json > ../backend-audit.json || true

      - name: Snyk scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Secret scan
        uses: trufflesecurity/trufflehog@v3.93.1
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: License check
        run: |
          npx license-checker --summary
          npx license-checker --production --json > licenses.json

      - name: Upload reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: security-reports
          path: |
            frontend-audit.json
            backend-audit.json
            licenses.json
          retention-days: 30

  # ── Dependency Updates ──────────────────────────────────────────────
  dependency-check:
    name: Dependency Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        workspace: [frontend, backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Check outdated packages
        working-directory: ${{ matrix.workspace }}
        run: npm outdated --json > outdated.json || true

      - name: Create or update dependency issue
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const workspace = '${{ matrix.workspace }}';
            try {
              const raw = fs.readFileSync(`${workspace}/outdated.json`, 'utf8').trim();
              if (!raw || raw === '{}') return;
              const outdated = JSON.parse(raw);
              const pkgs = Object.keys(outdated);
              if (pkgs.length === 0) return;

              const title = `deps(${workspace}): outdated packages`;
              const list = pkgs.slice(0, 20).map(p =>
                `- \`${p}\`: ${outdated[p].current} → ${outdated[p].latest}`
              ).join('\n');
              const extra = pkgs.length > 20 ? `\n\n...and ${pkgs.length - 20} more` : '';
              const body = `## Outdated packages in ${workspace}\n\n${list}${extra}\n\n_Last checked: ${new Date().toISOString()}_`;

              // Check for existing open issue with the same title
              const { data: existing } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: `dependencies,${workspace}`,
                per_page: 10
              });
              const match = existing.find(i => i.title === title);

              if (match) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: match.number,
                  body: body
                });
                console.log(`Updated existing issue #${match.number}`);
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['dependencies', workspace]
                });
                console.log('Created new issue');
              }
            } catch (e) {
              console.log('No outdated packages or error:', e.message);
            }
        continue-on-error: true

  # ── E2E Tests (Full Suite) ──────────────────────────────────────────
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: foodable_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build and start backend
        working-directory: backend
        run: |
          npm run build
          npm start &
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: root
          DB_PASSWORD: test_password
          DB_NAME: foodable_test
          JWT_SECRET: test-secret
          PORT: 8080

      - name: Build and serve frontend
        working-directory: frontend
        run: |
          npm run build
          npx vite preview --port 5173 &
        env:
          VITE_API_BASE_URL: http://localhost:8080

      - name: Wait for servers
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:8080/api/v1/health 2>/dev/null; do sleep 2; done' || echo "Backend not ready"
          timeout 60 bash -c 'until curl -sf http://localhost:5173 2>/dev/null; do sleep 2; done' || echo "Frontend not ready"

      - name: Run Playwright tests
        working-directory: frontend
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-${{ matrix.browser }}
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 14

  # ── Performance Audit ───────────────────────────────────────────────
  performance:
    name: Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install and build frontend
        run: |
          npm ci
          cd frontend && npm run build

      - name: Start preview server
        working-directory: frontend
        run: npx vite preview --port 5173 &

      - name: Wait for server
        run: timeout 60 bash -c 'until curl -sf http://localhost:5173 2>/dev/null; do sleep 2; done'

      - name: Lighthouse audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:5173
            http://localhost:5173/login
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Bundle size check
        working-directory: frontend
        run: |
          TOTAL=$(du -sb dist/ | cut -f1)
          MAX=$((5 * 1024 * 1024))
          echo "Bundle: $(($TOTAL / 1024))KB / $(($MAX / 1024))KB limit"
          du -h dist/assets/*.js 2>/dev/null | sort -h || true
          [ $TOTAL -le $MAX ] || echo "::warning::Bundle exceeds 5MB limit"

  # ── Node Compatibility ──────────────────────────────────────────────
  compatibility:
    name: Node.js Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        node-version: ['18', '20', '22']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: |
          cd frontend && npm run build && cd ..
          cd backend && npm run build

      - name: Frontend tests
        working-directory: frontend
        run: npm test -- --run
        env:
          CI: true

      - name: Backend tests
        working-directory: backend
        run: npm test
        env:
          CI: true
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret-key
          JWT_REFRESH_SECRET: test-refresh-secret-key
