name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)')
          DELETIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletion)')
          
          echo "Files changed: $CHANGED_FILES"
          echo "Lines added: ${ADDITIONS:-0}"
          echo "Lines deleted: ${DELETIONS:-0}"
          
          if [ "$CHANGED_FILES" -gt "100" ]; then
            echo "⚠️ Warning: Large PR with $CHANGED_FILES files changed"
            echo "::warning::Consider splitting into smaller PRs"
          fi

      - name: Check for breaking changes
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD | grep -i "breaking change"; then
            echo "⚠️ Breaking changes detected"
            echo "::warning::This PR contains breaking changes"
          fi

      - name: Labeler
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  conflict-check:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "<<<<<"; then
            echo "❌ Merge conflicts detected"
            exit 1
          else
            echo "✅ No merge conflicts"
          fi

  required-checks:
    name: Required Checks Status
    needs: [validate-pr, conflict-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check required validations
        run: |
          if [ "${{ needs.validate-pr.result }}" != "success" ] || \
             [ "${{ needs.conflict-check.result }}" != "success" ]; then
            echo "❌ PR validation failed"
            exit 1
          else
            echo "✅ PR validation passed"
          fi
